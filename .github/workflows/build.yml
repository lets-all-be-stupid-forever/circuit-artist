name: build Circuit Artist artifacts
on: [ push ]

jobs:
  build-artifacts:
    strategy:
      matrix:
        kinds:
        - machine: macos-13
          # language=sh
          build: |
            set -euo pipefail
            mkdir build
            cd    build
            cmake -G 'Unix Makefiles' -DCMAKE_BUILD_TYPE=Release ..
            make -C ../LuaJIT || true
            cmake --build .
            cd ..
            mkdir -p dist/bin
            cp build/ca dist/bin/
            cp build/*.dylib dist/bin/ 2>/dev/null || true
            cp LuaJIT/src/*.dylib dist/bin/ 2>/dev/null || true
            cp -r luasrc dist/
            cp -r assets dist/
            ls -la dist/bin/
        - machine: windows-2025
          # thankfully, windows-2019 ships with cmake in %ProgramFiles%
          # language=PowerShell
          build: |
            cd LuaJIT/src
            cmd /c msvcbuild.bat
            cd ../..
            mkdir build
            cd build
            cmake -DCMAKE_BUILD_TYPE=Release ..
            cmake --build . --config Release
            cd ..
            mkdir -p dist/bin
            cp build/Release/ca.exe dist/bin/
            cp build/Release/*.dll dist/bin/ -ErrorAction SilentlyContinue
            cp LuaJIT/src/*.dll dist/bin/ -ErrorAction SilentlyContinue
            cp -r luasrc dist/
            cp -r assets dist/
            gci -Path dist/bin -Recurse

    runs-on: ${{ matrix.kinds.machine }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'true'
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
    - name: cache luajit download
      uses: actions/cache@v4
      with:
        key: ${{ hashFiles('CMakeLists.txt') }}
        path: |
          third_party/*.gz
    - name: doit
      run: ${{ matrix.kinds.build }}
    - name: capture built artifact
      uses: actions/upload-artifact@v4
      with:
        name: circuit-artist-${{ matrix.kinds.machine }}
        path: dist/*
        retention-days: 7
